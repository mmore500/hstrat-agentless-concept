\section{Methods} \label{sec:methods}

Experiments were conducted \textit{in silico} using stochastic agent-based modeling approaches.
These simulations tracked populations of discrete agents, each competing to create offspring agents through asexual reproduction.
Within simulations, each agent possessed a set of genetic traits, inherited subject to mutation, that influenced reproductive success.
To assess the generality of our findings, we supplemented the simple ``counter-based'' genome model with Poisson-distributed mutations drawn from \cite{raynes2018sign} with an alternate ``site-explicit'' genome model.

This section reviews the model mechanics used across experiments in this work, as well as aspects of simulation design that we manipulated between treatment conditions.
Explored dimensions include population size, spatial population structure, background prevalence of hypermutator traits, and restriction of adaptive potential.
Finally, we describe notable implementation-level considerations necessary in harnessing high-performance computing hardware to achieve the expansive simulation scales explored in this work.

\subsection{Counter-based Genome Model} \label{sec:poisson}

Primary experiments in this work apply an agent-based modeling approach and parameters closely following work by \cite{raynes2018sign}.
Under this framework, agent genomes consist of two counters: one tracking beneficial mutations accumulated $n_b$ and the other tracking deleterious mutations accumulated $n_d$.
Mutations are assumed to have interchangeable fitness impacts, so a genomeâ€™s fitness score is calculated simply as $n_b - n_d$.
Details on how fitness scores guide selection are described in Section \ref{sec:evolution}.

A mutation process is applied to agent genomes each generation.
For each new agent, a count of discovered beneficial and deleterious mutations are drawn from independent Poisson distributions, with expected deleterious mutations per generation as
$\lambda_d=10^{-3}$ and expected beneficial mutations per generation as $\lambda_b=10^{-6}$.
That is, $\mathsf{offspring-}n_b = \mathsf{parent-}n_b + \mathrm{Pois}(\lambda_b)$ and $\mathsf{offspring-}n_d = \mathsf{parent-}n_d + \mathrm{Pois}(\lambda_d)$.
Reversions are not considered, so genomes' beneficial and deleterious mutation counts do not decrease from generation to generation.
In some experiments where adaptive potential was limited, we imposed an upper bound on the total quantity of beneficial mutations that could be accrued.
This was accomplished by applying a clip operation to the corresponding genome counters each time after mutation was applied.

Agent genomes additionally contain a boolean flag, signifying whether the agent expresses a hypermutator trait.
Agents with this trait incur a hundred-fold increase to mutation rates, $\hat{\lambda_d=10^{-3}} = 100 \times \lambda_d$ and $\hat{\lambda_b=10^{-3}} = 100 \times \lambda_b$.
Consistent with prior work \citep{raynes2018sign}, we conducted experiments initialized with an even mix of normo- and hypermutators;
agents in the founding population were randomly assigned hyper- or normomutator status, with equal probability.
In this ``50/50'' treatment, offspring always inherit their parent's mutator status.
In some experiments, we instead permit the hypermutator trait to be spontaneously conferred to offspring with probability $10^{-6}$.
This ``\textit{de novo}'' treatment assumes the founding population to be solely of normomutator type.
As with prior work \citep{raynes2018sign}, neither treatment allows hypermutator to normomutator reversion.

\subsection{Site-explicit Genome Model} \label{sec:site-explicit}

A key implicit assumption of the counter-based genome model, in its original formulation, is the availability of unlimited adaptive potential.
That is, an assumption that an unlimited number of beneficial (or deleterious) mutations may accumulate.
To better suit our exploration of scenarios with limited adaptive potential, we supplemented our work to include a genome model that more explicitly models a finite set of loci with adaptive potential.
One consequence of such a ``site-explicit'' model, in relation to the above counter-based approach, is that discoverable beneficial mutations become scarcer, and hence more difficult to discover, as adaptation unfolds.

Specifically, we model genomes as containing a discrete, finite set of loci $b_i \in \{0, 1\}$ available for adaptive mutation.
All loci are initialized $b_i = 0$.
Each locus has probability $p_b = 10^{-6}$ of transitioning $0 \rightarrow 1$ when inherited from parent to offspring.
Reversion mutations $1 \rightarrow 0$ are allowed, also with probability $p_{\sim b} = 10^{-6}$.

Because we do not limit the quantity of available deleterious mutations in our simulations, we maintained a counter-based approach in tracking deleterious mutations.
We maintain $\lambda_d = 10^{-3}$.
Hence, under the site-explicit model, we assign agents' fitness scores as $-n_d + \sum^n b_i$.

Site-explicit hypermutator mechanics also closely follow those under the counter-based model.
The hypermutator trait increases mutation rates hundredfold, setting $\hat{p_{b}} = \hat{p_{\sim b}} = 10^{-4}$ and $\hat{\lambda_d=10^{-1}}$.
Site-explicit experiments were conducted under both ``50/50'' and ``\textit{de novo}'' models of hypermutator introduction, identically to description above.

\subsection{Evolution Model} \label{sec:evolution}

Simulations applied tournament selection with synchronous generations and fixed population size.
For each available slot in a subpopulation's next generation, we sampled, with replacement, a pair of agents from that subpopulation.
With 90\% probability, the winner of the available slot was chosen randomly among the pair.
Otherwise, the available slot was assigned to the pair member with higher fitness score.
As such, fitness score improvements conferred a 10\% fitness advantage.

In simulations with spatial structure, populations were partitioned into well-mixed 256-agent ``demes.''
Where deme structure was used, selection solely competed agents inhabiting the same deme.
Each generation, migration between neighboring demes was applied by swapping a pair of agents.
Hence, demes received one immigrant from each neighbor per generation.
Under default conditions, demes were arranged as a two-dimensional grid lattice with non-toroidal boundaries (i.e., grid edges did not wrap around).
Under 1D structure treatments, demes were instead arranged in a ring configuration.
Finally, for well-mixed treatments, deme structure was broken down to treat entire populations as a single deme.

All 2D structure experiments used a square grid.
Hence, we chose to scale surveyed population sizes by factors of 9: $1 \times 1 \times 256,\;\; 3 \times 3 \times 256,\;\; 9 \times 9 \times 256,\;\; \ldots,\;\; 729 \times 729 \times 256$.
To efficiently batch our computations, we processed smaller population sizes as independent tiles of a larger, fixed-size fabric.
Hence, replicate count decreased with population size, but was boosted to at least 9 replicates in all cases.
Simulations lasted 500,000 generations.

The 50,000 generation duration was sufficient for populations to reach either hyper- or normomutator fixation in nearly all treatments.
However, some replicates involving 1D spatial structure at the largest-surveyed population size (for that condition, 15.1 million agents) did not reach a decisive end-state.
For this reason, we excluded 15.1 million agent populations with 1D structure from our analyses.
Additionally, we found that 256-agent populations failed accrue to more than 12 beneficial mutations within the 500,000 generation window.
For treatments where more than 12 beneficial mutations were availbe, some replicates therefore did not reach full adaptive potential.
Thus, we also excluded 256-agent simulations with more than 12 benficial mutations available from our analyses.

In data included in our presentation, $>97\%$ of replicates reached both hyper-/normomutator fixation and full adaptive potential.
Details on the fraction of replicates reaching fixation by experimental condition are provided in Supplementary Figures \cref{fig:neither-fixed-5050-cupy,fig:neither-fixed-denovo-cupy,fig:neither-fixed-wse-256atile,fig:neither-fixed-wse-altatile}.
Details on the fraction of replicates reaching full adaptive potential, measured for GPU-based simulations, appear in Supplementary Figures \cref{fig:unaccrued-5050-cupy,fig:unaccrued-denovo-cupy}.

\subsection{Hardware Accelerator Platforms} \label{sec:hardware}

To enable the simulation scale necessary for this work, we employed Graphics Processing Unit (GPU) and Wafer-Scale Engine (WSE) hardware accelerators.
The architectures of these hardware accelerators comprise large collections of worker processors specialized for numerical computation.
GPU hardware was NVIDIA A100 and WSE hardware was Cerebras CS-2 \citep{choquette2021nvidia,cerebras2021wafer}.
WSE hardware was hosted by the Neocortex installation at Pittsburgh Supercomputing Center \citep{buitrago2021neocortex}.

check matthias
check leighton
check lady from software workshop
The Cerebras Wafer-Scale Engine platform, in particular, is a notable exemplar among an emerging class of next-generation AI/ML-oriented hardware accelerators \citep{lauterbach2021path}.
Explorations are ongoing in establishing applications of these platforms for scientific and high-performance computing (HPC) \citep{rocki2020fast,brown2023exploring,ltaief2023scaling,sai2023massively,brown2022distributed,luow2020using,woo2022distributed,tramm2024efficient,chen2024using,phillips2023solving,chen2024solving}, including agent-based evolution simulations \citep{moreno2024trackable}.
The CS-2 chip comprises a grid lattice of 850,000 independent processor elements (PEs), each networked for low-latency communication with its four cardinal neighbors.

To suit the local lattice structure of the WSE's hardware architecture, all experiments on this platform employed 2D spatial population structure.
Each PE hosted a single deme, acting as an ``island.''
Agents migrated between neighboring PEs through asynchronous message passing;
% see e.g.,
% https://github.com/mmore500/wse-async-ga/blob/ebc92bd012f0bb31092c5e71825af041261c35c5/kernel-async-ga/kernel.csl
% and
% https://osf.io/esv9z
% (note that send flag is bumped twice per send cycle)https://osf.io/esv9z
in practice, each PE dispatched approximately one agent to each neighbor per generation.
Additionally, progress of each PE in stepping through agent generations within its own deme was allowed to proceed independently of other PEs.
Detail on more technical aspects of the Cerebras Software Language (CSL) kernel design used in this work is provided in \citet{moreno2024trackable}.

In some cases, experiments on WSE were extended beyond the $729 \times 729$ to fill the CS-2 WSE's entire $750 \times 994$ complement of available PEs.
In some trials, per-PE population sizes of 32 and 2,048 agents were used, to allow for finer granularity in scaling net agent count deme grid dimensions or for larger maximum population size.
At full wafer scale, our largest net population size reached 1.5 billion agents.

Given the stochastic nature in our agent-based evolution modeling, our experiments relied heavily on pseudorandom number generators (PRNGs).
These algorithms emulate true entropy by producing a sequence of output values that, although deterministic, are statistically independent.
Due to performance engineering considerations, vendor-supplied PRNG implementations for the WSE and GPU do not employ cryptographic-quality algorithms.
Our WSE simulations relied on Cerebras Software Language's PRNG utilities, which use a Linear-Feedback Shift Register (LFSR) approach with polynomial $3x^2 + 8x + 1$ strided by 128 iterations.
On GPU, we used CuPy's PRNG utilities, which expose CUDA's underlying XORWOW-based CuRAND implementation \citep{marsaglia2003xorshift}.
This PRNG also applies an LFSR approach \citep{brent2004note}.

PRNG patterning, particularly in lower-quality Linear Congruential Generator (LCG) algorithms, has been shown in some cases to substantially bias results \citep{click2010quality}.
Notably, we encountered one set of conditions where fixation probabilities for 12 beneficial mutations available deviated appreciably from that for 10 and 14 beneficial mutations available for single-deme populations.
The anomaly occurred solely under the site-explicit genome model, where the number of PRNG calls made to apply mutation to an agent differs with the quantity of available beneficial mutations.
Notably, because in this case each PE comprised a fully independent population, replicate count was very high ($n = 827 \times 827 = 683,929$), making the result all the more unexpected.

Fully re-running the affected simulation did not resolve the data anomaly.
However, modifying the simulation code to advance the PRNG engine via no-op calls within the body of the mutation operator brought the result in line with expectations.
Thus, it seems likely that in this instance the original simulation encountered a PRNG cycle or similar artifact.
As such, for one data point, we exclude the originally generated data in favor of the  PRNG no-op padded results.
On a broader basis, the generality of our findings is bolstered by consistencies where similar experiments are conducted on WSE and GPU.
Additionally, CuRAND's RNG has been extensively characterized and, although it exhibits statistically detectable flaws of its own, considered to be reasonable quality \citep{nvidia2024curand}.

\subsection{On-hardware Simulation Performance}
\label{sec:performance}

\input{fig/perf}

To assess the efficacy of hardware accelerator resources in expediting our simulations, we collected timings of execution duration from our simulation experiments.
As a baseline comparison point for performance, we also benchmarked simulation on CPU.

Figure \ref{fig:perf} compares simulation performance between hardware platforms, measured in agent-generations per second (AGPS).
Mean throughput was 7.0 (SD 0.5) million AGPS on CPU, 2.7 (SD 0.03) billion AGPS on GPU, and 780 (SD 0.5) billion on WSE for \textit{de novo} trials using the counter-based model.
Net speedup, normalized to mean CPU throughput, was $378\times$ (SD 4) on GPU and $111,091\times$ (SD 75) on WSE.
Normalized to net GPU performance, WSE provided a speedup of $294\times$ (SD 0.2).

Under the site-explicit model, WSE gave 650 (SD 50) billion AGPS under \textit{de novo} conditions.
The site-explicit model was not implemented on GPU.
For all the above, 50/50 trials gave similar performance to \textit{de novo}.

On WSE, we found agent-generation throughput to be generally consistent across per-PE population densities, as shown in Supplementary Figure \ref{fig:perf-tilepop}.
In contrast, mean GPU throughput dropped to 121 million AGPS when increasing net population size from 15.1 million to 175 million.
For this reason, we only scaled GPU simulations up to $243 \times 243$ demes.

\subsection{Software and Data Availability} \label{sec:materials}

Simulation code, configuration files, and batch scripts for this work are available via Zenodo at \url{https://doi.org/10.5281/zenodo.13983623}.
Postprocessing scripts and executable notebooks for this work are hosted separately, at \url{https://doi.org/10.5281/zenodo.13983579}.
Data and supplemental materials are available via the Open Science Framework \url{https://doi.org/10.17605/OSF.IO/YMAF8} \citep{foster2017open}.

This project benefited significantly from open-source scientific software \citep{2020SciPy-NMeth,harris2020array,reback2020pandas,mckinney-proc-scipy-2010,waskom2021seaborn,hunter2007matplotlib,moreno2023teeplot}.
